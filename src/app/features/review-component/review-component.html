<section class="container mx-auto px-4 sm:px-8 max-w-7xl">
  <div class="py-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold text-gray-900">Reviews</h1>
      <button (click)="refreshReviews()" class="btn btn-primary">
        Refresh
      </button>
    </div>

    <div class="flex flex-wrap gap-4 mb-4">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
        placeholder="Search by user, email, or comment"
        class="input input-bordered w-full max-w-xs"
      />

      <select
        [(ngModel)]="selectedEntityType"
        (change)="onFilterChange()"
        class="select select-bordered"
      >
        <option value="">All Entity Types</option>
        <option value="Product">Product</option>
        <option value="Service">Service</option>
      </select>

      <select
        [(ngModel)]="selectedMinRating"
        (change)="onFilterChange()"
        class="select select-bordered"
      >
        <option value="">All Ratings</option>
        <option value="1">1 Star & up</option>
        <option value="2">2 Stars & up</option>
        <option value="3">3 Stars & up</option>
        <option value="4">4 Stars & up</option>
        <option value="5">5 Stars</option>
      </select>

      <button (click)="clearFilters()" class="btn btn-outline">
        Clear Filters
      </button>
    </div>

    @if (loading()) {
    <div class="text-center my-8">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
    } @else {
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            @for (heading of ['ID', 'User', 'Entity', 'Rating', 'Review',
            'Date', 'Status', 'Actions']; track heading) {
            <th>{{ heading }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (review of filteredReviews(); track review._id) {
          <tr>
            <td>{{ (review._id || '').substring(0, 8) }}...</td>
            <td class="flex items-center space-x-2">
              <div class="avatar placeholder">
                <div class="bg-neutral text-neutral-content rounded-full w-8">
                  <span>{{ getUserInitials(getUserInfo(review).name) }}</span>
                </div>
              </div>
              <div>
                <div class="font-bold">{{ getUserInfo(review).name }}</div>
                <div class="text-sm text-gray-500">
                  {{ getUserInfo(review).email }}
                </div>
              </div>
            </td>
            <td>{{ getEntityName(review) }}</td>
            <td class="flex items-center space-x-1">
              @for (star of [1, 2, 3, 4, 5]; track star) {
              <svg
                xmlns="http://www.w3.org/2000/svg"
                [attr.fill]="review.rating >= star ? 'currentColor' : 'none'"
                viewBox="0 0 24 24"
                stroke="currentColor"
                class="w-4 h-4 text-yellow-500"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l2.141 6.594h6.923c.969 0 1.371 1.24.588 1.81l-5.605 4.073 2.142 6.594c.3.921-.755 1.688-1.54 1.118L12 18.347l-5.6 4.07c-.785.57-1.84-.197-1.54-1.118l2.142-6.594-5.605-4.073c-.783-.57-.38-1.81.588-1.81h6.923l2.141-6.594z"
                />
              </svg>
              }
            </td>
            <td>
              <span>
                {{ getTruncatedReview(review._id || '', review.comment || '') }}
              </span>
              @if (shouldTruncateReview(review.comment)) {
              <button
                (click)="toggleReviewExpansion(review._id || '')"
                class="text-blue-600 hover:underline text-sm ml-2"
              >
                {{ expandedReviews.has(review._id || '') ? 'Show Less' : 'Read
                More' }}
              </button>
              }
            </td>
            <td>{{ formatDate(review.createdAt) }}</td>
            <td>
              <span class="badge badge-outline badge-success">Active</span>
            </td>
            <td>
              <button
                class="btn btn-sm btn-error"
                (click)="deleteReview(review._id || '')"
                [disabled]="deletingReviewId() === (review._id || '')"
              >
                @if (deletingReviewId() === (review._id || '')) {
                <span class="loading loading-spinner loading-xs"></span>
                } @else { Delete }
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="flex justify-center mt-6">
      <div class="join">
        <button
          class="join-item btn"
          [disabled]="currentPage() === 1"
          (click)="previousPage()"
        >
          «
        </button>

        @for (page of getPageNumbers(); track page) {
        <button
          class="join-item btn"
          [ngClass]="{ 'btn-active': currentPage() === page }"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
        }

        <button
          class="join-item btn"
          [disabled]="currentPage() === totalPages()"
          (click)="nextPage()"
        >
          »
        </button>
      </div>
    </div>
    }
  </div>
</section>
