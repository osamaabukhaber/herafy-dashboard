<div class="max-w-7xl mx-auto p-5 bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="opacity-100 animate-[fadeInDown_0.6s_ease-out_0.1s_forwards] flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 p-6 bg-white rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-300">
    <h1 class="text-3xl font-bold text-gray-900 mb-4 lg:mb-0 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Update Cart</h1>
    <div class="flex gap-3">
      <button type="button" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 hover:scale-105 transition-all duration-200 shadow-sm hover:shadow-md" (click)="onCancel()">
        <span class="transform transition-transform duration-200 group-hover:-translate-x-1">←</span> Back to Carts
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="opacity-100 animate-[fadeIn_0.4s_ease-out_forwards] text-center py-16 bg-white rounded-lg shadow-sm border border-gray-100">
    <div class="inline-block w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
    <div class="space-y-2">
      <p class="text-gray-600 font-medium">Loading cart data...</p>
      <div class="w-48 h-2 bg-gray-200 rounded-full mx-auto overflow-hidden">
        <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full animate-[loadingBar_2s_ease-in-out_infinite]"></div>
      </div>
    </div>
  </div>

  <!-- Main Form -->
  <div *ngIf="!loading" class="opacity- animate-[fadeInUp_0.6s_ease-out_0.2s_forwards] bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-shadow duration-300">
    <form [formGroup]="cartForm" (ngSubmit)="onSubmit()" novalidate class="relative">

      <!-- Cart Basic Information -->
      <div class="p-8 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-blue-50">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
          <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full flex items-center justify-center">
          </div>
          Cart Information
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- User Field -->
          <div class="opacity-100 animate-[slideInLeft_0.5s_ease-out_0.3s_forwards] group">
            <label for="user" class="block text-sm font-medium text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">User ID *</label>
            <div class="relative">
              <input
                id="user"
                type="text"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-400"
                [class.border-red-500]="cartForm.get('user')?.invalid && cartForm.get('user')?.touched"
                [class.focus:ring-red-500]="cartForm.get('user')?.invalid && cartForm.get('user')?.touched"
                [class.border-green-500]="cartForm.get('user')?.valid && cartForm.get('user')?.touched"
                [class.focus:ring-green-500]="cartForm.get('user')?.valid && cartForm.get('user')?.touched"
                formControlName="user"
                placeholder="Enter user ID">
              <!-- Success Icon -->
              <div *ngIf="cartForm.get('user')?.valid && cartForm.get('user')?.touched"
                   class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500 animate-[bounceIn_0.5s_ease-out]">
                ✓
              </div>
              <!-- Error Icon -->
              <div *ngIf="cartForm.get('user')?.invalid && cartForm.get('user')?.touched"
                   class="absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500 animate-[shake_0.5s_ease-in-out]">
                ⚠
              </div>
            </div>
            <div *ngIf="cartForm.get('user')?.invalid && cartForm.get('user')?.touched"
                 class="mt-1 text-sm text-red-600 animate-[slideDown_0.3s_ease-out] flex items-center gap-1">
              <span class="animate-pulse">⚠</span>
              User is required
            </div>
          </div>

          <!-- Coupon Field -->
          <div class="opacity-100 animate-[slideInRight_0.5s_ease-out_0.4s_forwards] group">
            <label for="coupon" class="block text-sm font-medium text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">Coupon Code</label>
            <div class="relative">
              <input
                id="coupon"
                type="text"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-400"
                formControlName="coupon"
                placeholder="Enter coupon code (optional)">
            </div>
          </div>
        </div>

        <!-- Is Deleted Checkbox -->
        <div class="opacity-100 animate-[fadeIn_0.5s_ease-out_0.5s_forwards] mt-6">
          <div class="flex items-center group">
            <input
              id="isDeleted"
              type="checkbox"
              class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500 transition-all duration-200 hover:scale-110"
              formControlName="isDeleted">
            <label for="isDeleted" class="ml-2 text-sm font-medium text-gray-900 cursor-pointer group-hover:text-red-600 transition-colors duration-200">
              Mark as deleted
            </label>
          </div>
        </div>
      </div>

      <!-- Cart Items Section -->
      <div class="p-8">
        <div class="opacity-100 animate-[slideInUp_0.5s_ease-out_0.6s_forwards] flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
            <div class="w-6 h-6 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center">
            </div>
            Cart Items
          </h2>
          <button type="button" class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 hover:scale-105 transition-all duration-200 shadow-sm hover:shadow-md animate-pulse" (click)="addItem()">
            <span class="animate-bounce">+</span> Add Item
          </button>
        </div>

        <!-- Items List -->
        <div formArrayName="items" class="space-y-6">
          <div *ngIf="items.length === 0" class="opacity-100 animate-[bounceIn_0.6s_ease-out_0.7s_forwards] text-center py-12 border-2 border-dashed border-gray-300 rounded-lg bg-gradient-to-br from-gray-50 to-blue-50">
            <p class="text-gray-500 text-lg font-medium">No items in cart</p>
            <p class="text-gray-400 text-sm">Click "Add Item" to add products</p>
          </div>

          <div *ngFor="let item of items.controls; let i = index"
               [formGroupName]="i"
               class="opacity-100 animate-[slideInUp_0.5s_ease-out_forwards] border border-gray-200 rounded-lg overflow-hidden bg-gradient-to-br from-white to-gray-50 hover:shadow-lg transition-all duration-300 hover:scale-[1.02]"
               [style.animation-delay]="(0.8 + i * 0.1) + 's'">

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gradient-to-r from-gray-100 to-blue-100 border-b border-gray-200 gap-3">
              <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <span class="w-6 h-6 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-full flex items-center justify-center text-sm">{{ i + 1 }}</span>
                Item {{ i + 1 }}
              </h3>
              <button
                type="button"
                class="inline-flex items-center gap-2 px-3 py-1.5 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 hover:scale-105 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                (click)="removeItem(i)"
                [disabled]="items.length <= 1">
                Remove
              </button>
            </div>

            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- Product Name -->
                <div class="lg:col-span-2 group">
                  <label class="block text-sm font-medium text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">Product *</label>
                  <div class="relative">
                    <input
                      type="text"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-400"
                      [class.border-red-500]="item.get('product')?.invalid && item.get('product')?.touched"
                      [class.focus:ring-red-500]="item.get('product')?.invalid && item.get('product')?.touched"
                      [class.border-green-500]="item.get('product')?.valid && item.get('product')?.touched"
                      [class.focus:ring-green-500]="item.get('product')?.valid && item.get('product')?.touched"
                      formControlName="product"
                      placeholder="Enter product name">
                    <!-- Success/Error Icons -->
                    <div *ngIf="item.get('product')?.valid && item.get('product')?.touched"
                         class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500 animate-[bounceIn_0.5s_ease-out]">✓</div>
                    <div *ngIf="item.get('product')?.invalid && item.get('product')?.touched"
                         class="absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500 animate-[shake_0.5s_ease-in-out]">⚠</div>
                  </div>
                  <div *ngIf="item.get('product')?.invalid && item.get('product')?.touched"
                       class="mt-1 text-sm text-red-600 animate-[slideDown_0.3s_ease-out] flex items-center gap-1">
                    <span class="animate-pulse">⚠</span>
                    Product name is required
                  </div>
                </div>

                <!-- Quantity -->
                <div class="group">
                  <label class="block text-sm font-medium text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">Quantity *</label>
                  <div class="relative">
                    <input
                      type="number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-400"
                      [class.border-red-500]="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                      [class.focus:ring-red-500]="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                      [class.border-green-500]="item.get('quantity')?.valid && item.get('quantity')?.touched"
                      [class.focus:ring-green-500]="item.get('quantity')?.valid && item.get('quantity')?.touched"
                      formControlName="quantity"
                      min="1"
                      placeholder="1">
                    <!-- Success/Error Icons -->
                    <div *ngIf="item.get('quantity')?.valid && item.get('quantity')?.touched"
                         class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500 animate-[bounceIn_0.5s_ease-out]">✓</div>
                    <div *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                         class="absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500 animate-[shake_0.5s_ease-in-out]">⚠</div>
                  </div>
                  <div *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                       class="mt-1 text-sm text-red-600 animate-[slideDown_0.3s_ease-out] flex items-center gap-1">
                    <span class="animate-pulse">⚠</span>
                    <span *ngIf="item.get('quantity')?.errors?.['required']">Quantity is required</span>
                    <span *ngIf="item.get('quantity')?.errors?.['min']">Minimum quantity is 1</span>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Price -->
                <div class="group">
                  <label class="block text-sm font-medium text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">Price *</label>
                  <div class="relative">
                    <input
                      type="number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-400"
                      [class.border-red-500]="item.get('price')?.invalid && item.get('price')?.touched"
                      [class.focus:ring-red-500]="item.get('price')?.invalid && item.get('price')?.touched"
                      [class.border-green-500]="item.get('price')?.valid && item.get('price')?.touched"
                      [class.focus:ring-green-500]="item.get('price')?.valid && item.get('price')?.touched"
                      formControlName="price"
                      min="0"
                      step="0.01"
                      placeholder="0.00">
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                      <span *ngIf="item.get('price')?.valid && item.get('price')?.touched"
                            class="text-green-500 animate-[bounceIn_0.5s_ease-out]">✓</span>
                      <span *ngIf="item.get('price')?.invalid && item.get('price')?.touched"
                            class="text-red-500 animate-[shake_0.5s_ease-in-out]">⚠</span>
                    </div>
                  </div>
                  <div *ngIf="item.get('price')?.invalid && item.get('price')?.touched"
                       class="mt-1 text-sm text-red-600 animate-[slideDown_0.3s_ease-out] flex items-center gap-1">
                    <span class="animate-pulse">⚠</span>
                    <span *ngIf="item.get('price')?.errors?.['required']">Price is required</span>
                    <span *ngIf="item.get('price')?.errors?.['min']">Price must be 0 or greater</span>
                  </div>
                </div>
              </div>

              <!-- Variants Section -->
              <div formGroupName="variant" class="border-t border-gray-200 pt-6 animate-[fadeIn_0.5s_ease-out_0.8s_forwards] opacity-100">
                <h4 class="text-sm font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  Product Variants
                </h4>
                <div *ngIf="getVariantKeys(item.get('variant')!).length === 0" class="p-4 bg-gradient-to-r from-gray-100 to-blue-100 border border-gray-200 rounded-md">
                  <p class="text-sm text-gray-600 italic flex items-center gap-2">
                    No variants available for this item
                  </p>
                </div>
                <div *ngIf="getVariantKeys(item.get('variant')!).length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div *ngFor="let variantKey of getVariantKeys(item.get('variant')!); let j = index"
                       class="space-y-2 opacity-100 animate-[slideInUp_0.4s_ease-out_forwards] group"
                       [style.animation-delay]="(0.9 + j * 0.1) + 's'">
                    <label class="block text-sm font-medium text-gray-700 transition-colors group-focus-within:text-purple-600">{{ variantKey | titlecase }} *</label>
                    <div class="relative">
                      <input
                        aria-label="Enter"
                        type="text"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 hover:border-gray-400"
                        [class.border-red-500]="getVariantControl(item, variantKey)?.invalid && getVariantControl(item, variantKey)?.touched"
                        [class.focus:ring-red-500]="getVariantControl(item, variantKey)?.invalid && getVariantControl(item, variantKey)?.touched"
                        [class.border-green-500]="getVariantControl(item, variantKey)?.valid && getVariantControl(item, variantKey)?.touched"
                        [class.focus:ring-green-500]="getVariantControl(item, variantKey)?.valid && getVariantControl(item, variantKey)?.touched"
                        [formControlName]="variantKey"
                        [placeholder]="'Enter ' + variantKey">
                      <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                        <span *ngIf="getVariantControl(item, variantKey)?.valid && getVariantControl(item, variantKey)?.touched"
                              class="text-green-500 animate-[bounceIn_0.5s_ease-out]">✓</span>
                        <span *ngIf="getVariantControl(item, variantKey)?.invalid && getVariantControl(item, variantKey)?.touched"
                              class="text-red-500 animate-[shake_0.5s_ease-in-out]">⚠</span>
                      </div>
                    </div>
                    <div *ngIf="getVariantControl(item, variantKey)?.invalid && getVariantControl(item, variantKey)?.touched"
                         class="text-sm text-red-600 animate-[slideDown_0.3s_ease-out] flex items-center gap-1">
                      <span class="animate-pulse">⚠</span>
                      {{ variantKey | titlecase }} is required
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="opacity-100 animate-[slideInUp_0.5s_ease-out_1s_forwards] flex flex-col sm:flex-row justify-end gap-3 p-6 bg-gradient-to-r from-gray-50 to-blue-50 border-t border-gray-200">
        <button
          type="button"
          class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 hover:scale-105 transition-all duration-200 shadow-sm hover:shadow-md"
          (click)="onCancel()">
          Cancel
        </button>
        <button
          type="submit"
          class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hover:scale-105 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 inline-flex items-center gap-2 relative overflow-hidden"
          [disabled]="cartForm.invalid || loading">
          <div *ngIf="loading" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span [class.animate-pulse]="cartForm.valid">Update Cart</span>
        </button>
      </div>

      <!-- Form Debug (Enhanced) -->
      <div class="px-6 py-4 bg-gradient-to-r from-yellow-50 to-amber-50 border-t border-yellow-200 opacity-100 animate-[slideInUp_0.5s_ease-out_1.1s_forwards]" *ngIf="false">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-6 h-6 bg-gradient-to-r from-yellow-500 to-amber-500 rounded-full flex items-center justify-center animate-pulse">
            <span class="text-white text-sm">🔍</span>
          </div>
          <h3 class="text-lg font-semibold text-yellow-800">Form Debug Panel</h3>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Form Data -->
          <div class="bg-white rounded-lg border border-yellow-200 p-4 hover:shadow-md transition-shadow duration-200">
            <h4 class="font-semibold text-yellow-700 mb-2 flex items-center gap-2">
               Form Data
            </h4>
            <pre class="bg-gray-50 p-3 rounded border text-sm overflow-x-auto max-h-64 font-mono">{{ cartForm.value | json }}</pre>
          </div>

          <!-- Form Status -->
          <div class="bg-white rounded-lg border border-yellow-200 p-4 hover:shadow-md transition-shadow duration-200">
            <h4 class="font-semibold text-yellow-700 mb-2 flex items-center gap-2">
             Form Status
            </h4>
            <div class="space-y-2 text-sm">
              <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <span class="font-medium">Form Valid:</span>
                <span [class]="cartForm.valid ? 'text-green-600 animate-pulse' : 'text-red-600 animate-bounce'">
                  {{ cartForm.valid ? '✅ Valid' : '❌ Invalid' }}
                </span>
              </div>
              <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <span class="font-medium">Form Touched:</span>
                <span [class]="cartForm.touched ? 'text-blue-600' : 'text-gray-500'">
                  {{ cartForm.touched ? ' Touched' : 'Untouched' }}
                </span>
              </div>
              <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <span class="font-medium">Form Dirty:</span>
                <span [class]="cartForm.dirty ? 'text-orange-600' : 'text-gray-500'">
                  {{ cartForm.dirty ? 'Modified' : ' Pristine' }}
                </span>
              </div>
            </div>
            <div *ngIf="cartForm.errors" class="mt-3 p-2 bg-red-50 border border-red-200 rounded">
              <p class="text-sm font-medium text-red-700 flex items-center gap-1">
                Form Errors:
              </p>
              <pre class="text-xs text-red-600 mt-1 font-mono">{{ cartForm.errors | json }}</pre>
            </div>
          </div>
        </div>

        <!-- Field Status Grid -->
        <div class="mt-6 bg-white rounded-lg border border-yellow-200 p-4 hover:shadow-md transition-shadow duration-200">
          <h4 class="font-semibold text-yellow-700 mb-3 flex items-center gap-2">
            Field Validation Status
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
            <!-- User Field Status -->
            <div class="p-2 border rounded flex items-center justify-between"
                 [class]="cartForm.get('user')?.valid ? 'border-green-200 bg-green-50' : cartForm.get('user')?.invalid && cartForm.get('user')?.touched ? 'border-red-200 bg-red-50' : 'border-gray-200 bg-gray-50'">
              <span class="font-medium">User ID</span>
            </div>

            <!-- Add more field status indicators as needed -->
            <div class="p-2 border rounded flex items-center justify-between"
                 [class]="cartForm.get('coupon')?.pristine ? 'border-gray-200 bg-gray-50' : 'border-blue-200 bg-blue-50'">
              <span class="font-medium">Coupon</span>
            </div>

            <div class="p-2 border rounded flex items-center justify-between"
                 [class]="cartForm.get('isDeleted')?.value ? 'border-red-200 bg-red-50' : 'border-gray-200 bg-gray-50'">
              <span class="font-medium">Is Deleted</span>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
